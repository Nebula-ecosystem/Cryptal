name: Cryptography CI

on:
  push:
  pull_request:

jobs:
  build_libs:
    runs-on: ubuntu-latest
    outputs:
      crate-name: ${{ steps.getcrate.outputs.name }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Get crate name
        id: getcrate
        run: |
          NAME=$(grep -E '^name\s*=' Cargo.toml | head -1 | cut -d'"' -f2)
          if [ -z "$NAME" ]; then
            echo "Failed to detect crate name from Cargo.toml" >&2
            exit 1
          fi
          echo "name=$NAME" >> "$GITHUB_OUTPUT"

      - name: Build default
        run: cargo build --release
      - name: Save default (only the main crate rlib)
        run: |
          set -euo pipefail
          mkdir -p lib_default
          CRATE="${{ steps.getcrate.outputs.name }}"
          RLIB=$(ls target/release/deps/lib${CRATE}-*.rlib | head -1)
          if [ -z "${RLIB:-}" ]; then
            echo "Main crate rlib not found for default build" >&2
            ls -la target/release/deps || true
            exit 1
          fi
          cp "$RLIB" "lib_default/lib${CRATE}.rlib"
      - uses: actions/upload-artifact@v4
        with:
          name: lib_default
          path: lib_default/lib${{ steps.getcrate.outputs.name }}.rlib

      - name: Build speed
        run: cargo build --release --features speed
      - name: Save speed (only the main crate rlib)
        run: |
          set -euo pipefail
          mkdir -p lib_speed
          CRATE="${{ steps.getcrate.outputs.name }}"
          RLIB=$(ls target/release/deps/lib${CRATE}-*.rlib | head -1)
          if [ -z "${RLIB:-}" ]; then
            echo "Main crate rlib not found for speed build" >&2
            ls -la target/release/deps || true
            exit 1
          fi
          cp "$RLIB" "lib_speed/lib${CRATE}.rlib"
      - uses: actions/upload-artifact@v4
        with:
          name: lib_speed
          path: lib_speed/lib${{ steps.getcrate.outputs.name }}.rlib

      - name: Build ref (includes benches to ensure reference code path is compiled)
        run: cargo build --release --benches
      - name: Save ref (only the main crate rlib)
        run: |
          set -euo pipefail
          mkdir -p lib_ref
          CRATE="${{ steps.getcrate.outputs.name }}"
          RLIB=$(ls target/release/deps/lib${CRATE}-*.rlib | head -1)
          if [ -z "${RLIB:-}" ]; then
            echo "Main crate rlib not found for ref build" >&2
            ls -la target/release/deps || true
            exit 1
          fi
          cp "$RLIB" "lib_ref/lib${CRATE}.rlib"
      - uses: actions/upload-artifact@v4
        with:
          name: lib_ref
          path: lib_ref/lib${{ steps.getcrate.outputs.name }}.rlib

  test_default:
    runs-on: ubuntu-latest
    needs: build_libs
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run tests (default)
        run: cargo test --verbose

  test_speed:
    runs-on: ubuntu-latest
    needs: build_libs
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run tests (speed)
        run: cargo test --verbose --features speed

  bench_default:
    runs-on: windows-latest # Use Windows runners to reflect typical user HW and avoid AVX2 skew.
    needs: [build_libs, test_default, test_speed]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Run Classic 256
        run: cargo bench --bench sha256

      - uses: actions/download-artifact@v4
        with:
          name: lib_default
          path: lib

      - name: Extract mean
        shell: bash
        run: |
          set -euo pipefail
          FILE="target/criterion/sha256/new/estimates.json"
          if [ ! -f "$FILE" ]; then
            echo "Bench estimates not found: $FILE" >&2
            find target/criterion -maxdepth 3 -type f -name estimates.json -print || true
            exit 1
          fi
          M=$(jq '.mean.point_estimate' "$FILE")
          echo "$M" > mean.txt

      - name: Extract size (exact crate rlib)
        shell: bash
        run: |
          set -euo pipefail
          CRATE="${{ needs.build_libs.outputs.crate-name }}"
          LIB="lib/lib${CRATE}.rlib"
          if [ ! -f "$LIB" ]; then
            echo "Downloaded rlib not found: $LIB" >&2
            ls -la lib || true
            exit 1
          fi
          stat -c %s "$LIB" > size.txt

      - uses: actions/upload-artifact@v4
        with:
          name: classic256
          path: |
            mean.txt
            size.txt

  bench_speed:
    runs-on: windows-latest
    needs: [build_libs, test_default, test_speed]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Run Turbo 256
        run: cargo bench --bench sha256 --features speed

      - uses: actions/download-artifact@v4
        with:
          name: lib_speed
          path: lib

      - name: Extract mean
        shell: bash
        run: |
          set -euo pipefail
          FILE="target/criterion/sha256/new/estimates.json"
          if [ ! -f "$FILE" ]; then
            echo "Bench estimates not found: $FILE" >&2
            find target/criterion -maxdepth 3 -type f -name estimates.json -print || true
            exit 1
          fi
          M=$(jq '.mean.point_estimate' "$FILE")
          echo "$M" > mean.txt

      - name: Extract size (exact crate rlib)
        shell: bash
        run: |
          set -euo pipefail
          CRATE="${{ needs.build_libs.outputs.crate-name }}"
          LIB="lib/lib${CRATE}.rlib"
          if [ ! -f "$LIB" ]; then
            echo "Downloaded rlib not found: $LIB" >&2
            ls -la lib || true
            exit 1
          fi
          stat -c %s "$LIB" > size.txt

      - uses: actions/upload-artifact@v4
        with:
          name: turbo256
          path: |
            mean.txt
            size.txt

  bench_ref:
    runs-on: windows-latest
    needs: [build_libs, test_default, test_speed]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Run Reference 256
        run: cargo bench --bench sha256_ref

      - uses: actions/download-artifact@v4
        with:
          name: lib_ref
          path: lib

      - name: Extract mean
        shell: bash
        run: |
          set -euo pipefail
          FILE="target/criterion/sha256_ref/new/estimates.json"
          if [ ! -f "$FILE" ]; then
            echo "Bench estimates not found: $FILE" >&2
            find target/criterion -maxdepth 3 -type f -name estimates.json -print || true
            exit 1
          fi
          M=$(jq '.mean.point_estimate' "$FILE")
          echo "$M" > mean.txt

      - name: Extract size (exact crate rlib)
        shell: bash
        run: |
          set -euo pipefail
          CRATE="${{ needs.build_libs.outputs.crate-name }}"
          LIB="lib/lib${CRATE}.rlib"
          if [ ! -f "$LIB" ]; then
            echo "Downloaded rlib not found: $LIB" >&2
            ls -la lib || true
            exit 1
          fi
          stat -c %s "$LIB" > size.txt

      - uses: actions/upload-artifact@v4
        with:
          name: ref256
          path: |
            mean.txt
            size.txt

  summary:
    runs-on: ubuntu-latest
    needs: [bench_default, bench_speed, bench_ref]
    steps:
      - uses: actions/download-artifact@v4

      - name: Print summary
        run: |
          set -euo pipefail
          M_DEF=$(cat classic256/mean.txt)
          S_DEF=$(cat classic256/size.txt)
          M_SPD=$(cat turbo256/mean.txt)
          S_SPD=$(cat turbo256/size.txt)
          M_REF=$(cat ref256/mean.txt)
          S_REF=$(cat ref256/size.txt)

          echo
          echo "=== Performance Summary ==="
          printf "%-20s | %-12s | %-12s\n" "Version" "Speed" "Size"
          printf "%-20s-+-%-12s-+-%-12s\n" "--------------------" "------------" "------------"
          printf "%-20s | %-12s | %-12s\n" "Classic 256" "$M_DEF" "$S_DEF"
          printf "%-20s | %-12s | %-12s\n" "Turbo 256"   "$M_SPD" "$S_SPD"
          printf "%-20s | %-12s | %-12s\n" "Reference 256" "$M_REF" "$S_REF"
